<!DOCTYPE html><html lang="en-us"><head><link href="http://gmpg.org/xfn/11" rel="profile" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><meta http-equiv="content-type" content="text/html; charset=utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" /><title>æ”¾ç€, æˆ‘æ¥</title><link rel="stylesheet" href="https://zhongl.github.io/public/css/poole.css" /><link rel="stylesheet" href="https://zhongl.github.io/public/css/syntax.css" /><link rel="stylesheet" href="https://zhongl.github.io/public/css/hyde.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:400" /><link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://zhongl.github.io/public/apple-touch-icon-144-precomposed.png" /><link rel="shortcut icon" href="https://zhongl.github.io/public/favicon.ico" /><script src="https://www.googletagmanager.com/gtag/js?id=UA-6664231-5"></script><script> window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-6664231-5');
    </script></head><body class=" "><div class="sidebar"><div class="container sidebar-sticky"><div class="sidebar-about"><h1>æ”¾ç€, æˆ‘æ¥</h1><blockquote>ç†æƒ³å’Œæƒ…æ€€æ˜¯æœ‰ä»£ä»·çš„, ä½†å¥½åœ¨å®ƒä¸æ˜¯è‡ªç”±çš„æ·é”, è€Œåº”è¯¥æ˜¯çœŸæ­£çš„è‡ªç”±æœ¬èº«. <a href="https://weibo.com/1875401263/DDSIEbOJy">by @dcaoyuan</a></blockquote></div><nav class="sidebar-nav"><a class="sidebar-nav-item" href="https://zhongl.github.io/">Home</a><a class="sidebar-nav-item" href="https://github.com/zhongl">Github</a><a class="sidebar-nav-item" href="https://speakerdeck.com/zhongl/">Speaker</a><a class="sidebar-nav-item" href="http://cafusic.lofter.com/">Lofter</a></nav><p>&copy; 2021. All rights reserved</p></div></div><div class="content container"><div class="post"><h1 class="post-title">é›¶ä¾µå…¥å¼å¯åŠ¨javaagentåœ¨stagemonitorä¸­çš„å®ç°</h1><p class="post-meta">17 Feb 2017 @<a href="https://github.com/zhongl">zhongl</a></p><input type="hidden" name="id" value="starting javaagent with zero change in stagemonitor" />
<input type="hidden" name="created" value="2017-02-17" />
<h1 id="å¯åŠ¨-javaagent">å¯åŠ¨ Javaagent</h1>
<p><strong>ä»¥ä¸‹æ‘˜è‡ª <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html">Oracle Javase 8 Doc</a></strong> ï¼š</p>
<blockquote>
<p>Command-Line Interface</p>
<p>An implementation is not required to provide a way to start agents from the command-line interface. On implementations that do provide a way to start agents from the command-line interface, an agent is started by adding this option to the command-line:</p>
<p><code>-javaagent:jarpath[=options]</code></p>
</blockquote>
<p>é€šè¿‡<strong>å‘½ä»¤è¡Œå‚æ•°</strong>çš„æ–¹å¼å¯åŠ¨ Javaagent æ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§æ–¹å¼ï¼Œä½†å´<strong>ä¸æ˜¯å”¯ä¸€çš„æ–¹å¼</strong>ã€‚æ­£å¦‚æ–‡æ¡£ä¸­æåˆ°çš„ï¼Œ å¯åŠ¨ Javaagent å…¶å®æ˜¯æœ‰ä¸¤ä¸ªå…¥å£æ–¹æ³•ï¼š</p>
<pre><code class="language-java">public static void premain(...);        // [1]

public static void agentmain(...);      // [2]
</code></pre>
<ol>
<li>å‘½ä»¤è¡Œå‚æ•°çš„æ–¹å¼å¯åŠ¨çš„æ˜¯ <code>premain</code>ï¼Œè€Œå¦ä¸€ç§</li>
<li><code>agentmain</code> åˆ™æ˜¯é€šè¿‡ <a href="http://docs.oracle.com/javase/8/docs/jdk/api/attach/spec/index.html">Attach API</a> å¯åŠ¨çš„ï¼Œå¦‚ä¸‹ï¼š</li>
</ol>
<pre><code class="language-java">String pid = ...
VirtualMachine vm = VirtualMachine.attach(pid);
vm.loadAgent(&quot;/path/to/agent&quot;);
vm.detach();
</code></pre>
<h1 id="é›¶ä¾µå…¥å¼éšjvmè¿è¡Œè€Œå¯åŠ¨-javaagent">é›¶ä¾µå…¥å¼éšJVMè¿è¡Œè€Œå¯åŠ¨ Javaagent</h1>
<p>æ‰€è°“é›¶ä¾µå…¥ï¼Œ æ˜¯æŒ‡å¯¹ç›®æ ‡JVMåº”ç”¨ä¸åšä»»ä½•ä¿®æ”¹ï¼Œæœ‰ä¸”ä»…å°† Javaagent ç½®äºç‰¹å®šçš„ä½ç½®å°±èƒ½å®ç°å¯¹å…¶å¯åŠ¨å‘¢ï¼Ÿ</p>
<p>åªæ˜¯åŸºäºå‰æ–‡çš„çŸ¥è¯†ï¼Œå‡ ä¹æ˜¯ä¸å¯èƒ½åšåˆ°çš„ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘æ›¾å’Œä¸€ä½èµ„æ·±ä¸“å®¶èŠåˆ°è¿‡è¿™ä¸ªè¯é¢˜ï¼Œä»–å¯å‘æˆ‘ä» <a href="https://github.com/hexdecteam/stagemonitor/tree/easestack-0.25.0">stagemonitor</a> ä¸­æ‰¾åˆ°äº†ç­”æ¡ˆã€‚</p>
<!--more-->
<p>å…¶å®ï¼Œè¦æƒ³å¯åŠ¨ Javaagent å°±ä¸å¯èƒ½å­˜åœ¨æœ‰åˆ«äºå‰æ–‡çš„ç¬¬ä¸‰ç§é€”å¾„ï¼Œæ¯•ç«Ÿ JVM çš„å®ç°åªæä¾›äº†è¿™ä¸¤ç§ã€‚</p>
<p>äºŒé€‰ä¸€ï¼Œé—®é¢˜æ¯”åŸå…ˆæƒ³è±¡çš„è¦ç®€å•ã€‚æˆ‘ä»¬å¯ä»¥æ’é™¤<strong>å‘½ä»¤è¡Œå‚æ•°</strong>çš„æ–¹å¼ï¼Œå› ä¸ºå®ƒå¿…é¡»è¦æ”¹å˜ JVM åº”ç”¨åŸæœ‰çš„å¯åŠ¨å‘½ä»¤ã€‚é‚£ä¹ˆå‰©ä¸‹ <strong>Attach API</strong> çš„æ–¹å¼æ˜¯å”¯ä¸€çš„é€‰æ‹©ï¼Œ æ¥ä¸‹æ¥è¦ææ˜ç™½çš„äº‹æƒ…æ˜¯ <strong>ç”±è°æ¥æ‰§è¡Œé¢„å…ˆå‡†å¤‡å¥½çš„ Attach è¿‡ç¨‹</strong>ã€‚</p>
<p>çœ‹ä¼¼å°±å‰© â€œæœ€åä¸€å…¬é‡Œâ€ï¼Œå®åœ¨ä¸ç„¶ã€‚æ£æ‘©ä¹‹å‰ï¼Œå¿…é¡»ç ´é™¤ä¸¤ä¸ªæ€ç»´çš„é™åˆ¶ï¼š</p>
<ol>
<li>å¯¹ <strong>Attach API</strong> çš„è°ƒç”¨åªèƒ½æ˜¯åœ¨å¦ä¸ªè¿›ç¨‹ä¸­æ‰§è¡Œï¼›</li>
<li>å¯¹ <strong>Instrumentation API</strong> çš„è°ƒç”¨åªèƒ½åœ¨ <code>agentmain</code> æ–¹æ³•ä¸­æ‰§è¡Œã€‚</li>
</ol>
<p><a href="https://github.com/hexdecteam/stagemonitor/tree/easestack-0.25.0">stagemonitor</a> æ°æ°æ˜¯å› ä¸ºæ²¡æœ‰ä¸Šè¿°ä¸¤å µæ€ç»´çš„å¢™ï¼Œå› è€Œå®ç°å¾—éå¸¸å·§å¦™ã€‚</p>
<h1 id="serviceloader">ServiceLoader</h1>
<p>Tomcat ä½œä¸º Servlet å®¹å™¨çš„æ ‡å‡†å®ç°ï¼Œå€ŸåŠ© <a href="http://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html">ServiceLoader</a> å›è°ƒæ‰€æœ‰èƒ½å¤Ÿ <strong>æ‰¾åˆ°</strong> çš„<code>ServletContainerInitializer</code> æ¥å£çš„å®ç°è€…ã€‚</p>
<p><a href="https://github.com/hexdecteam/stagemonitor/tree/easestack-0.25.0">stagemonitor</a> ä¸­ <a href="https://github.com/hexdecteam/stagemonitor/blob/easestack-0.25.0/stagemonitor-web/src/main/java/org/stagemonitor/web/WebPlugin.java#L47">WebPlugin</a> å®ç°äº† <code>ServletContainerInitializer</code> æ¥å£ï¼Œ å¹¶åœ¨ç±»åˆå§‹åŒ–é˜¶æ®µå®Œæˆ <strong>Attach</strong> çš„<a href="https://github.com/hexdecteam/stagemonitor/blob/easestack-0.25.0/stagemonitor-web/src/main/java/org/stagemonitor/web/WebPlugin.java#L56">è¿‡ç¨‹</a>ã€‚</p>
<pre><code class="language-java">public class WebPlugin extends StagemonitorPlugin 
  implements ServletContainerInitializer {

	static  {
		Stagemonitor.init();
	}
	
	...
}	
</code></pre>
<blockquote>
<p>è¿™é‡Œæ‰“ç ´äº†ç¬¬ä¸€å µå¢™ï¼Œåœ¨åŒä¸€è¿›ç¨‹å†…æ‰§è¡Œ <strong>Attach</strong>ã€‚</p>
</blockquote>
<h1 id="bytebuddy">ByteBuddy</h1>
<p>çœ‹è¿‡æºç ä¹‹åï¼Œ ä½ å¯èƒ½ä¼šç–‘æƒ‘ï¼Œ<a href="https://github.com/hexdecteam/stagemonitor/tree/easestack-0.25.0">stagemonitor</a> å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ <strong>Attach API</strong>ï¼Œ è€Œæ˜¯åœ¨<a href="https://github.com/hexdecteam/stagemonitor/blob/easestack-0.25.0/stagemonitor-core/src/main/java/org/stagemonitor/core/instrument/AgentAttacher.java#L94">AgentAttacher</a> ä¸­é‡‡ç”¨ <a href="http://bytebuddy.net/#/">ByteBuddy</a> æä¾›çš„ <code>ByteBuddyAgent.install</code> æ¥è·å¾— <strong>Instrumentation</strong> çš„å®ä¾‹ï¼Œè¿›è€Œå®Œæˆä¿®æ”¹å­—èŠ‚ç çš„é€»è¾‘ã€‚</p>
<blockquote>
<p>è¿™é‡Œæ‰“ç ´äº†ç¬¬äºŒå µå¢™ï¼Œ<code>ByteBuddyAgent.install</code> åœ¨è¿è¡Œæ—¶å°† <a href="https://github.com/raphw/byte-buddy/blob/master/byte-buddy-agent/src/main/java/net/bytebuddy/agent/Installer.java#L69">Installer</a> å˜æˆ <a href="https://github.com/raphw/byte-buddy/blob/master/byte-buddy-agent/src/main/java/net/bytebuddy/agent/ByteBuddyAgent.java#L796">Javaagent</a> äº¤ç”± JVM è¿›è¡Œå›è°ƒ <code>agentmain</code>ï¼Œ ä»…ä»…åªä¸ºè·å¾— <strong>Instrumentation</strong> çš„å®ä¾‹å¼•ç”¨ã€‚è‡³äºå¦‚ä½•ä½¿ç”¨ <strong>Instrumentation</strong> å®Œå…¨å¯ä»¥ä¸åœ¨ <code>agentmain</code> ä¸­æ‰§è¡Œã€‚</p>
</blockquote>
<h1 id="é›¶ä¾µå…¥çš„ä»£ä»·">é›¶ä¾µå…¥çš„ä»£ä»·</h1>
<p>çœ‹ä¼¼ç”¨æˆ·ä½“éªŒå‹å¥½çš„å®Œç¾æ–¹æ¡ˆï¼Œå…¶å®æ˜¯æœ‰â€œä»£ä»·â€çš„ï¼š</p>
<ol>
<li>è¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹ Tomcat åº”ç”¨åœºæ™¯çš„ç‰¹å®šæ–¹æ¡ˆï¼Œå¹¶ä¸é€‚ç”¨äºæ‰€æœ‰çš„ JVM åº”ç”¨ï¼Œè¿™åœ¨ <a href="https://github.com/hexdecteam/stagemonitor/tree/easestack-0.25.0">stagemonitor</a> çš„ <a href="https://github.com/stagemonitor/stagemonitor/wiki/Step-1%3A-In-Browser-Widget#embedded-servlet-containers">wiki</a> ä¸­ä¹Ÿæœ‰ä½“ç°ï¼›</li>
<li><strong>Attach API</strong> å¹¶éç”±æ ‡å‡†åº“æä¾›ï¼Œè¿™æ„å‘³ç€æ²¡æœ‰å®‰è£… JDK ï¼ˆä»…æœ‰ JREï¼‰çš„ç¯å¢ƒæ˜¯ä¸æ”¯æŒçš„ï¼Œè¿™ç‚¹åœ¨ stagemonitor çš„ wiki ä¸­ä¹Ÿæœ‰<a href="https://github.com/stagemonitor/stagemonitor/wiki/Installation">å£°æ˜</a>ï¼›</li>
<li><strong>Attach API</strong> å¯åŠ¨ Javaagent ï¼ˆå›è°ƒ <code>agentmain</code>ï¼‰çš„æ—¶æœºæ˜¯åœ¨ <code>main</code> æ–¹æ³•å¼€å§‹ä¹‹åçš„ï¼Œè¿™æ„å‘³ç€åœ¨å¯åŠ¨ä¹‹å‰å·²ç»å®Œæˆè£…è½½çš„å­—èŠ‚ç ï¼Œå“ªæ€•æ˜¯å±äºä¿®æ”¹èŒƒç•´ï¼Œåœ¨ Javaagent å¯åŠ¨åçš„è¿›è¡Œä¿®æ”¹ä¹Ÿæ˜¯ä¸ä¼šç”Ÿæ•ˆï¼Œé™¤éç‰¹åˆ«æŒ‡å®šè¦ <code>Instrumentation.retransformClasses(Class&lt;?&gt;... classes)</code>ã€‚</li>
</ol>
<p>é›¶ä¾µå…¥å¸¦æ¥çš„å‹å¥½ä½“éªŒï¼Œç›¸å¯¹äºé€šè¿‡ä¿®æ”¹ <strong>å‘½ä»¤è¡Œå‚æ•°</strong> è€Œè¨€å¹¶ä¸è§å¾—æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ã€‚ åŒæ ·æ˜¯ Tomcat çš„åœºæ™¯ï¼Œ å®ç° <strong>å‘½ä»¤è¡Œå‚æ•°</strong> çš„<a href="http://stackoverflow.com/questions/6697063/adding-javaagent-to-tomcat-6-server-where-do-i-put-it-and-in-what-format">æ–¹å¼</a>:</p>
<pre><code>CATALINA_OPTS=&quot;$CATALINA_OPTS -javaagent:/path/to/agent&quot;
</code></pre>
<h1 id="åè®°">åè®°</h1>
<p><a href="https://github.com/hexdecteam/stagemonitor/tree/easestack-0.25.0">stagemonitor</a> çš„é›¶ä¾µå…¥æ€è·¯æ˜¯å¯ä»¥å€Ÿé‰´å¹¶ä¸¾ä¸€åä¸‰çš„ï¼Œä½†å…¶ä»£ç çš„å®ç°æ–¹å¼æœªå¿…æ˜¯æœ€ç®€æ´ä¼˜é›…çš„ï¼Œè‡³å°‘æˆ‘åœ¨çœ‹çš„æ—¶å€™æœ‰ç§åƒç¿”çš„æ„Ÿè§‰ ğŸ˜‚ ã€‚</p>
<div><a href="https://zhongl.github.io/tags/bytebuddy" class="post-badge">bytebuddy</a><a href="https://zhongl.github.io/tags/javaagent" class="post-badge">javaagent</a><a href="https://github.com/zhongl/zhongl.github.com/issues/18" class="post-comment">Comment(0)</a></div><div></div></div></div></body></html>